<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FANTASTICO | La Liga Fantasy League</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #050d1a;
    --navy2: #0a1628;
    --teal: #00f5d4;
    --pink: #ff4ecd;
    --gold: #ffd700;
    --blue: #0066ff;
    --card-bg: rgba(10, 22, 40, 0.85);
    --border: rgba(0, 245, 212, 0.25);
    --glow-teal: 0 0 20px rgba(0,245,212,0.4);
    --glow-pink: 0 0 20px rgba(255,78,205,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--navy);
    color: #e0f7f4;
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,245,212,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,245,212,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 20% 50%, rgba(0,102,255,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 20%, rgba(255,78,205,0.06) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(5,13,26,0.95);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(20px);
    padding: 0 1.5rem;
  }

  .header-inner {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .logo {
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    font-size: 1.4rem;
    color: var(--teal);
    text-shadow: var(--glow-teal);
    letter-spacing: 3px;
  }

  .logo span { color: var(--pink); }

  .gw-badge {
    background: rgba(0,245,212,0.1);
    border: 1px solid var(--teal);
    border-radius: 4px;
    padding: 4px 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    color: var(--teal);
    letter-spacing: 2px;
  }

  /* NAV */
  nav {
    background: rgba(5,13,26,0.9);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 60px;
    z-index: 99;
    overflow-x: auto;
  }

  nav::-webkit-scrollbar { height: 2px; }
  nav::-webkit-scrollbar-thumb { background: var(--teal); }

  .nav-inner {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 0;
  }

  .nav-btn {
    background: none;
    border: none;
    color: rgba(224,247,244,0.5);
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 14px 20px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    position: relative;
  }

  .nav-btn:hover { color: var(--teal); }

  .nav-btn.active {
    color: var(--teal);
    border-bottom-color: var(--teal);
    text-shadow: var(--glow-teal);
  }

  /* MAIN */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  /* PAGES */
  .page { display: none; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* CARDS */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    backdrop-filter: blur(20px);
    overflow: hidden;
  }

  .card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .card-title {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--teal);
    letter-spacing: 3px;
    text-transform: uppercase;
    text-shadow: var(--glow-teal);
  }

  .card-body { padding: 1.5rem; }

  /* GRID LAYOUTS */
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
  .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }

  /* STAT BOXES */
  .stat-box {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }

  .stat-box:hover {
    transform: translateY(-2px);
    border-color: var(--teal);
    box-shadow: var(--glow-teal);
  }

  .stat-box::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--teal), var(--pink));
  }

  .stat-value {
    font-family: 'Orbitron', monospace;
    font-size: 2.5rem;
    font-weight: 900;
    color: var(--teal);
    text-shadow: var(--glow-teal);
    line-height: 1;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.7rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(224,247,244,0.5);
    font-weight: 700;
  }

  /* BUTTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 10px 22px;
    border-radius: 4px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .btn-teal {
    background: rgba(0,245,212,0.15);
    color: var(--teal);
    border: 1px solid var(--teal);
  }
  .btn-teal:hover {
    background: var(--teal);
    color: var(--navy);
    box-shadow: var(--glow-teal);
  }

  .btn-pink {
    background: rgba(255,78,205,0.15);
    color: var(--pink);
    border: 1px solid var(--pink);
  }
  .btn-pink:hover {
    background: var(--pink);
    color: white;
    box-shadow: var(--glow-pink);
  }

  .btn-gold {
    background: rgba(255,215,0,0.15);
    color: var(--gold);
    border: 1px solid var(--gold);
  }
  .btn-gold:hover { background: var(--gold); color: var(--navy); }

  .btn-sm { padding: 6px 14px; font-size: 0.75rem; }

  /* LEADERBOARD */
  .lb-row {
    display: grid;
    grid-template-columns: 40px 1fr auto auto auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }

  .lb-row:hover { background: rgba(0,245,212,0.04); }
  .lb-row:last-child { border-bottom: none; }

  .lb-rank {
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    font-size: 1rem;
    text-align: center;
  }

  .rank-1 { color: var(--gold); text-shadow: 0 0 10px rgba(255,215,0,0.5); }
  .rank-2 { color: #c0c0c0; }
  .rank-3 { color: #cd7f32; }

  .lb-manager { font-size: 1rem; font-weight: 700; }
  .lb-team { font-size: 0.75rem; color: rgba(224,247,244,0.5); }

  .lb-pts {
    font-family: 'Orbitron', monospace;
    font-weight: 700;
    color: var(--teal);
    text-shadow: var(--glow-teal);
  }

  /* PLAYER TABLE */
  .player-table { width: 100%; border-collapse: collapse; }

  .player-table th {
    padding: 10px 12px;
    text-align: left;
    font-size: 0.65rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(0,245,212,0.6);
    font-family: 'Orbitron', monospace;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    white-space: nowrap;
  }

  .player-table th:hover { color: var(--teal); }

  .player-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(0,245,212,0.07);
    font-size: 0.9rem;
    vertical-align: middle;
  }

  .player-table tr:hover td { background: rgba(0,245,212,0.04); }

  .pos-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-family: 'Orbitron', monospace;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .pos-GK { background: rgba(255,215,0,0.2); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
  .pos-DEF { background: rgba(0,102,255,0.2); color: #4da6ff; border: 1px solid rgba(0,102,255,0.3); }
  .pos-MID { background: rgba(0,245,212,0.15); color: var(--teal); border: 1px solid rgba(0,245,212,0.25); }
  .pos-FWD { background: rgba(255,78,205,0.15); color: var(--pink); border: 1px solid rgba(255,78,205,0.25); }

  .player-owned { opacity: 0.4; }

  /* DRAFT PICKS */
  .draft-order {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .draft-pick-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: rgba(0,245,212,0.05);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .pick-num {
    font-family: 'Orbitron', monospace;
    font-size: 0.7rem;
    color: var(--teal);
    width: 50px;
    flex-shrink: 0;
  }

  .pick-manager { flex: 1; font-weight: 700; }

  .pick-current {
    border-color: var(--pink);
    background: rgba(255,78,205,0.08);
    animation: pulse-border 1.5s ease-in-out infinite;
  }

  @keyframes pulse-border {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: var(--glow-pink); }
  }

  /* SQUAD GRID */
  .squad-grid { display: flex; flex-direction: column; gap: 1rem; }

  .squad-row {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .player-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem;
    width: 110px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .player-card:hover {
    border-color: var(--teal);
    box-shadow: var(--glow-teal);
    transform: translateY(-2px);
  }

  .player-card.captain {
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(255,215,0,0.3);
  }

  .player-card.bench {
    opacity: 0.6;
    border-style: dashed;
  }

  .player-card-name {
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 4px;
    line-height: 1.2;
  }

  .player-card-pts {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    color: var(--teal);
    font-weight: 700;
  }

  .captain-crown {
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--gold);
    color: var(--navy);
    font-size: 0.55rem;
    padding: 1px 6px;
    border-radius: 2px;
    font-weight: 900;
    letter-spacing: 1px;
    font-family: 'Orbitron', monospace;
  }

  /* SECTION LABEL */
  .section-label {
    font-family: 'Orbitron', monospace;
    font-size: 0.6rem;
    letter-spacing: 3px;
    color: rgba(0,245,212,0.5);
    text-align: center;
    padding: 4px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.75rem;
  }

  /* TRANSFERS */
  .transfer-panel {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1rem;
    align-items: start;
  }

  .transfer-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 3rem;
    color: var(--pink);
    font-size: 1.5rem;
  }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    align-items: center;
  }

  .filter-select {
    background: rgba(10,22,40,0.9);
    border: 1px solid var(--border);
    color: #e0f7f4;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    outline: none;
  }

  .filter-select:focus { border-color: var(--teal); }

  .filter-input {
    background: rgba(10,22,40,0.9);
    border: 1px solid var(--border);
    color: #e0f7f4;
    padding: 8px 14px;
    border-radius: 4px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.85rem;
    outline: none;
    flex: 1;
    min-width: 140px;
  }

  .filter-input::placeholder { color: rgba(224,247,244,0.3); }
  .filter-input:focus { border-color: var(--teal); }

  /* TRANSACTION LOG */
  .tx-item {
    display: grid;
    grid-template-columns: 100px 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }

  .tx-item:last-child { border-bottom: none; }
  .tx-gw { font-family: 'Share Tech Mono', monospace; color: var(--teal); font-size: 0.75rem; }
  .tx-penalty { color: var(--pink); font-family: 'Orbitron', monospace; font-size: 0.8rem; font-weight: 700; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--navy2);
    border: 1px solid var(--teal);
    border-radius: 8px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--glow-teal);
    animation: fadeIn 0.2s ease;
  }

  .modal-title {
    font-family: 'Orbitron', monospace;
    color: var(--teal);
    font-size: 0.9rem;
    letter-spacing: 3px;
    margin-bottom: 1rem;
    text-shadow: var(--glow-teal);
  }

  .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

  /* SCROLL CONTAINER */
  .table-wrap { overflow-x: auto; }
  .table-wrap::-webkit-scrollbar { height: 3px; }
  .table-wrap::-webkit-scrollbar-thumb { background: var(--teal); }

  /* SETUP SCREEN */
  .setup-screen {
    max-width: 600px;
    margin: 4rem auto;
    text-align: center;
  }

  .setup-screen h1 {
    font-family: 'Orbitron', monospace;
    font-size: 2rem;
    color: var(--teal);
    text-shadow: var(--glow-teal);
    margin-bottom: 0.5rem;
    letter-spacing: 4px;
  }

  .setup-screen p {
    color: rgba(224,247,244,0.6);
    margin-bottom: 2rem;
    letter-spacing: 1px;
  }

  .manager-inputs { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }

  .manager-input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

  input[type="text"], input[type="number"] {
    background: rgba(10,22,40,0.9);
    border: 1px solid var(--border);
    color: #e0f7f4;
    padding: 10px 14px;
    border-radius: 4px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 1rem;
    outline: none;
    width: 100%;
  }

  input[type="text"]:focus, input[type="number"]:focus { border-color: var(--teal); }
  input::placeholder { color: rgba(224,247,244,0.3); }

  /* PAGE TITLE */
  .page-title {
    font-family: 'Orbitron', monospace;
    font-size: 1.2rem;
    color: var(--teal);
    letter-spacing: 3px;
    text-shadow: var(--glow-teal);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .page-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--teal), transparent);
  }

  /* PITCH VIEW */
  .pitch {
    background: linear-gradient(180deg, #1a5c2a 0%, #1e6b31 50%, #1a5c2a 100%);
    border-radius: 8px;
    padding: 1.5rem;
    position: relative;
    border: 2px solid rgba(255,255,255,0.1);
  }

  .pitch::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: 
      repeating-linear-gradient(180deg, rgba(255,255,255,0.04) 0px, rgba(255,255,255,0.04) 1px, transparent 1px, transparent 80px);
    border-radius: 6px;
  }

  /* STATUS DOT */
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }
  .dot-live { background: #00ff88; box-shadow: 0 0 8px #00ff88; animation: blink 1s infinite; }
  .dot-off { background: rgba(255,255,255,0.3); }

  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* NOTIFICATION */
  .notification {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: rgba(0,245,212,0.15);
    border: 1px solid var(--teal);
    color: var(--teal);
    padding: 1rem 1.5rem;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 1px;
    z-index: 999;
    transform: translateX(120%);
    transition: transform 0.3s ease;
    box-shadow: var(--glow-teal);
    max-width: 300px;
  }

  .notification.show { transform: translateX(0); }
  .notification.error { border-color: var(--pink); color: var(--pink); background: rgba(255,78,205,0.1); box-shadow: var(--glow-pink); }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .grid-3 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: 1fr; }
    .lb-row { grid-template-columns: 30px 1fr auto; }
    .lb-row > :nth-child(4), .lb-row > :nth-child(5) { display: none; }
    .transfer-panel { grid-template-columns: 1fr; }
    .transfer-arrow { transform: rotate(90deg); padding: 0; }
    .player-card { width: 90px; }
    .header-inner { flex-wrap: wrap; height: auto; padding: 0.75rem 0; gap: 0.5rem; }
    main { padding: 1rem; }
    .modal { padding: 1.5rem; }
    .tx-item { grid-template-columns: 80px 1fr auto; font-size: 0.8rem; }
  }

  .color-teal { color: var(--teal); }
  .color-pink { color: var(--pink); }
  .color-gold { color: var(--gold); }
  .mt-1 { margin-top: 1rem; }
  .mt-15 { margin-top: 1.5rem; }
  .mb-1 { margin-bottom: 1rem; }
  .mb-15 { margin-bottom: 1.5rem; }
  .text-sm { font-size: 0.8rem; color: rgba(224,247,244,0.5); }
  .text-mono { font-family: 'Share Tech Mono', monospace; }
  .fw-bold { font-weight: 700; }
  .text-center { text-align: center; }
  .flex { display: flex; }
  .flex-center { display: flex; align-items: center; justify-content: center; }
  .gap-1 { gap: 1rem; }
  .gap-05 { gap: 0.5rem; }
  .w-100 { width: 100%; }
  .empty-state { text-align: center; padding: 3rem; color: rgba(224,247,244,0.3); font-size: 0.9rem; letter-spacing: 1px; }
</style>
</head>
<body>

<!-- SETUP MODAL -->
<div class="modal-overlay" id="setupModal" style="z-index:1000;">
  <div class="modal" style="max-width:560px;">
    <div class="modal-title">‚öΩ FANTASTICO SETUP</div>
    <p class="text-sm mb-15">Configure your league before the season begins.</p>
    <div class="manager-inputs" id="managerInputs">
      <div class="manager-input-row">
        <input type="text" placeholder="Manager 1 Name" id="m1name" value="El Presidente">
        <input type="text" placeholder="Team Name" id="m1team" value="Los Gal√°cticos">
      </div>
      <div class="manager-input-row">
        <input type="text" placeholder="Manager 2 Name" id="m2name" value="The Gaffer">
        <input type="text" placeholder="Team Name" id="m2team" value="FC Vice City">
      </div>
      <div class="manager-input-row">
        <input type="text" placeholder="Manager 3 Name" id="m3name" value="El M√≠ster">
        <input type="text" placeholder="Team Name" id="m3team" value="Neon United">
      </div>
    </div>
    <button class="btn btn-teal w-100" onclick="initLeague()">‚ö° INITIALISE LEAGUE</button>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-title" id="confirmTitle">CONFIRM ACTION</div>
    <p id="confirmMsg" style="font-size:0.9rem; line-height:1.6;"></p>
    <div class="modal-actions">
      <button class="btn btn-teal" id="confirmYes">CONFIRM</button>
      <button class="btn btn-pink" onclick="closeConfirm()">CANCEL</button>
    </div>
  </div>
</div>

<!-- PLAYER DETAIL MODAL -->
<div class="modal-overlay" id="playerModal">
  <div class="modal">
    <div class="modal-title" id="pModalName">PLAYER</div>
    <div id="pModalContent"></div>
    <div class="modal-actions">
      <button class="btn btn-pink btn-sm" onclick="closePlayerModal()">CLOSE</button>
    </div>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<header>
  <div class="header-inner">
    <div class="logo">FANTAS<span>TICO</span></div>
    <div class="flex gap-1" style="align-items:center;">
      <div id="updateStatus"><span class="status-dot dot-off"></span><span class="text-sm text-mono" style="font-size:0.7rem;">OFFLINE</span></div>
      <div class="gw-badge" id="gwBadge">GW 1</div>
    </div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <button class="nav-btn active" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button class="nav-btn" onclick="showPage('draft')">üéØ Draft</button>
    <button class="nav-btn" onclick="showPage('myteam')">üëï My Team</button>
    <button class="nav-btn" onclick="showPage('transfers')">üîÑ Transfers</button>
    <button class="nav-btn" onclick="showPage('players')">üìã Players</button>
    <button class="nav-btn" onclick="showPage('leaderboard')">üèÜ Leaderboard</button>
    <button class="nav-btn" onclick="showPage('log')">üßæ Log</button>
  </div>
</nav>

<main>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="page-title">DASHBOARD</div>
    <div class="grid-3 mb-15" id="dashStats"></div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">LEADERBOARD</span>
          <span class="text-sm text-mono" id="dashGW">GW 1</span>
        </div>
        <div id="dashLeaderboard"></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">THIS WEEK</span></div>
        <div class="card-body" id="dashThisWeek"></div>
      </div>
    </div>
    <div class="card mt-1">
      <div class="card-header">
        <span class="card-title">CONTROLS</span>
        <span class="text-sm">Admin actions</span>
      </div>
      <div class="card-body flex gap-1" style="flex-wrap:wrap;">
        <button class="btn btn-teal btn-sm" onclick="refreshStats()">‚Üª FETCH STATS</button>
        <button class="btn btn-pink btn-sm" onclick="nextGameweek()">‚è≠ NEXT GAMEWEEK</button>
        <button class="btn btn-gold btn-sm" onclick="resetAll()">‚ö† RESET ALL</button>
        <button class="btn btn-teal btn-sm" onclick="showPage('myteam')">üëÅ VIEW MY TEAM</button>
      </div>
    </div>
  </div>

  <!-- DRAFT -->
  <div class="page" id="page-draft">
    <div class="page-title">SNAKE DRAFT</div>
    <div id="draftContent"></div>
  </div>

  <!-- MY TEAM -->
  <div class="page" id="page-myteam">
    <div class="page-title">MY TEAM</div>
    <div class="flex gap-1 mb-1" style="align-items:center; flex-wrap:wrap;">
      <div>
        <span class="text-sm">Viewing: </span>
        <select class="filter-select" id="myteamManager" onchange="renderMyTeam()"></select>
      </div>
      <div class="text-sm text-mono" id="myteamPts" style="margin-left:auto;"></div>
    </div>
    <div id="myteamContent"></div>
  </div>

  <!-- TRANSFERS -->
  <div class="page" id="page-transfers">
    <div class="page-title">TRANSFERS</div>
    <div class="flex gap-1 mb-1" style="align-items:center; flex-wrap:wrap;">
      <div>
        <span class="text-sm">Manager: </span>
        <select class="filter-select" id="transferManager" onchange="renderTransfers()"></select>
      </div>
      <div id="transferCostInfo" class="text-sm text-mono"></div>
    </div>
    <div id="transferContent"></div>
  </div>

  <!-- PLAYERS -->
  <div class="page" id="page-players">
    <div class="page-title">PLAYER DATABASE</div>
    <div class="filter-bar">
      <input class="filter-input" type="text" placeholder="Search player..." id="playerSearch" oninput="renderPlayers()">
      <select class="filter-select" id="posFilter" onchange="renderPlayers()">
        <option value="">All Positions</option>
        <option value="GK">GK</option>
        <option value="DEF">DEF</option>
        <option value="MID">MID</option>
        <option value="FWD">FWD</option>
      </select>
      <select class="filter-select" id="teamFilter" onchange="renderPlayers()">
        <option value="">All Teams</option>
      </select>
      <select class="filter-select" id="sortFilter" onchange="renderPlayers()">
        <option value="pts">Sort: Points</option>
        <option value="goals">Sort: Goals</option>
        <option value="assists">Sort: Assists</option>
        <option value="name">Sort: Name</option>
      </select>
    </div>
    <div class="card">
      <div class="table-wrap">
        <table class="player-table" id="playerTable">
          <thead>
            <tr>
              <th>Player</th>
              <th>Pos</th>
              <th>Club</th>
              <th>GLS</th>
              <th>ASS</th>
              <th>CS</th>
              <th>YC</th>
              <th>RC</th>
              <th>PTS</th>
              <th>Owner</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="playerTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="page" id="page-leaderboard">
    <div class="page-title">LEADERBOARD</div>
    <div class="grid-2 mb-15">
      <div class="card">
        <div class="card-header"><span class="card-title">OVERALL STANDINGS</span></div>
        <div id="lbOverall"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">GW STANDINGS</span>
          <select class="filter-select" id="lbGWSelect" onchange="renderLeaderboard()" style="font-size:0.75rem; padding:4px 8px;"></select>
        </div>
        <div id="lbGW"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">TRANSFER PENALTIES</span></div>
      <div id="lbPenalties"></div>
    </div>
  </div>

  <!-- TRANSACTION LOG -->
  <div class="page" id="page-log">
    <div class="page-title">TRANSACTION LOG</div>
    <div class="card">
      <div class="card-header"><span class="card-title">ALL TRANSFERS</span></div>
      <div id="txLog"></div>
    </div>
  </div>

</main>

<script>
// =============================================================================
// STATE
// =============================================================================
let STATE = {
  managers: [], // [{id, name, teamName}]
  currentGW: 1,
  draftComplete: false,
  draftOrder: [], // [{managerIdx, pick}]
  draftPickIdx: 0,
  squads: {}, // managerId -> {gk:[], def:[], mid:[], fwd:[]}
  lineups: {}, // managerId -> gw -> {gk, def, mid, fwd, flex, captain, bench}
  playerStats: [], // array of player objects
  gwHistory: {}, // managerId -> gw -> {pts, transferPenalty}
  transfers: [], // [{gw, managerId, out:playerName, in:playerName, penalty}]
  transfersThisGW: {}, // managerId -> count
  lastFetch: null,
  apiData: null,
};

// =============================================================================
// LA LIGA PLAYER DATA (built-in seed data + API fetch overlay)
// =============================================================================
const SEED_PLAYERS = [
  // Real Madrid
  {id:1,name:'T. Courtois',club:'Real Madrid',pos:'GK',goals:0,assists:0,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  {id:2,name:'D. Carvajal',club:'Real Madrid',pos:'DEF',goals:1,assists:2,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:4,interceptions:5,keyPasses:2,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  {id:3,name:'E. Milit√£o',club:'Real Madrid',pos:'DEF',goals:1,assists:0,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:8,interceptions:7,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:1},
  {id:4,name:'D. Alaba',club:'Real Madrid',pos:'DEF',goals:0,assists:1,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:5,interceptions:4,keyPasses:1,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  {id:5,name:'F. Mendy',club:'Real Madrid',pos:'DEF',goals:0,assists:1,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:6,interceptions:3,keyPasses:1,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  {id:6,name:'T. Kroos',club:'Real Madrid',pos:'MID',goals:2,assists:5,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:2,interceptions:2,keyPasses:12,shotsOnTarget:4,bigChancesCreated:3,motm:2},
  {id:7,name:'L. Modric',club:'Real Madrid',pos:'MID',goals:2,assists:4,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:3,interceptions:3,keyPasses:9,shotsOnTarget:5,bigChancesCreated:2,motm:1},
  {id:8,name:'Aurelien Tchouam√©ni',club:'Real Madrid',pos:'MID',goals:1,assists:2,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:3,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:8,interceptions:6,keyPasses:4,shotsOnTarget:2,bigChancesCreated:1,motm:0},
  {id:9,name:'V. Jr.',club:'Real Madrid',pos:'FWD',goals:9,assists:6,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:5,shotsOnTarget:18,bigChancesCreated:4,motm:3},
  {id:10,name:'K. Benzema',club:'Real Madrid',pos:'FWD',goals:8,assists:4,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:3,shotsOnTarget:15,bigChancesCreated:2,motm:2},
  {id:11,name:'R. Bellingham',club:'Real Madrid',pos:'MID',goals:10,assists:5,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:4,interceptions:3,keyPasses:8,shotsOnTarget:12,bigChancesCreated:2,motm:4},
  // Barcelona
  {id:12,name:'M. ter Stegen',club:'Barcelona',pos:'GK',goals:0,assists:0,cleanSheets:5,saves:28,penaltySaves:1,goalsConceded:8,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:1},
  {id:13,name:'R. Ara√∫jo',club:'Barcelona',pos:'DEF',goals:2,assists:0,cleanSheets:4,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:9,interceptions:8,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:1},
  {id:14,name:'J. Gavi',club:'Barcelona',pos:'MID',goals:3,assists:5,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:4,redCards:1,ownGoals:0,penaltiesMissed:0,tacklesWon:6,interceptions:4,keyPasses:11,shotsOnTarget:6,bigChancesCreated:3,motm:1},
  {id:15,name:'P. Pedri',club:'Barcelona',pos:'MID',goals:4,assists:6,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:3,interceptions:2,keyPasses:14,shotsOnTarget:7,bigChancesCreated:4,motm:2},
  {id:16,name:'Frenkie de Jong',club:'Barcelona',pos:'MID',goals:2,assists:4,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:5,interceptions:3,keyPasses:9,shotsOnTarget:4,bigChancesCreated:2,motm:0},
  {id:17,name:'R. Lewandowski',club:'Barcelona',pos:'FWD',goals:12,assists:3,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:1,tacklesWon:0,interceptions:0,keyPasses:2,shotsOnTarget:20,bigChancesCreated:3,motm:4},
  {id:18,name:'A. Yamal',club:'Barcelona',pos:'FWD',goals:7,assists:8,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:4,shotsOnTarget:10,bigChancesCreated:5,motm:3},
  {id:19,name:'J. Cancelo',club:'Barcelona',pos:'DEF',goals:1,assists:4,cleanSheets:4,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:5,interceptions:3,keyPasses:7,shotsOnTarget:2,bigChancesCreated:2,motm:0},
  {id:20,name:'I. Gundogan',club:'Barcelona',pos:'MID',goals:3,assists:5,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:2,interceptions:2,keyPasses:10,shotsOnTarget:5,bigChancesCreated:2,motm:1},
  // Atletico Madrid
  {id:21,name:'J. Oblak',club:'Atletico',pos:'GK',goals:0,assists:0,cleanSheets:6,saves:32,penaltySaves:1,goalsConceded:6,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:2},
  {id:22,name:'A. Griezmann',club:'Atletico',pos:'FWD',goals:8,assists:5,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:4,shotsOnTarget:14,bigChancesCreated:3,motm:3},
  {id:23,name:'S. de Paul',club:'Atletico',pos:'MID',goals:2,assists:4,cleanSheets:4,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:3,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:7,interceptions:5,keyPasses:6,shotsOnTarget:3,bigChancesCreated:1,motm:0},
  {id:24,name:'K. Trippier',club:'Atletico',pos:'DEF',goals:1,assists:5,cleanSheets:5,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:3,interceptions:2,keyPasses:8,shotsOnTarget:2,bigChancesCreated:2,motm:1},
  {id:25,name:'J. F√©lix',club:'Atletico',pos:'FWD',goals:5,assists:3,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:3,shotsOnTarget:10,bigChancesCreated:2,motm:1},
  // Sevilla
  {id:26,name:'Y. En-Nesyri',club:'Sevilla',pos:'FWD',goals:7,assists:2,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:1,shotsOnTarget:13,bigChancesCreated:1,motm:2},
  {id:27,name:'I. Rakitiƒá',club:'Sevilla',pos:'MID',goals:2,assists:3,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:3,interceptions:3,keyPasses:7,shotsOnTarget:4,bigChancesCreated:1,motm:0},
  // Real Sociedad
  {id:28,name:'M. Oyarzabal',club:'Real Sociedad',pos:'FWD',goals:6,assists:4,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:3,shotsOnTarget:11,bigChancesCreated:2,motm:2},
  {id:29,name:'D. Silva',club:'Real Sociedad',pos:'MID',goals:3,assists:6,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:2,interceptions:1,keyPasses:13,shotsOnTarget:5,bigChancesCreated:4,motm:2},
  // Valencia
  {id:30,name:'H. Duro',club:'Valencia',pos:'FWD',goals:5,assists:2,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:1,shotsOnTarget:9,bigChancesCreated:1,motm:0},
  // Villarreal
  {id:31,name:'G. Moreno',club:'Villarreal',pos:'FWD',goals:5,assists:3,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:2,shotsOnTarget:10,bigChancesCreated:2,motm:1},
  {id:32,name:'F. Coquelin',club:'Villarreal',pos:'MID',goals:0,assists:2,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:7,interceptions:6,keyPasses:3,shotsOnTarget:1,bigChancesCreated:0,motm:0},
  // Betis
  {id:33,name:'N. Fekir',club:'Betis',pos:'MID',goals:4,assists:4,cleanSheets:1,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:2,interceptions:2,keyPasses:8,shotsOnTarget:6,bigChancesCreated:3,motm:1},
  // GK backup
  {id:34,name:'R. Dmitrovic',club:'Sevilla',pos:'GK',goals:0,assists:0,cleanSheets:2,saves:20,penaltySaves:0,goalsConceded:12,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  {id:35,name:'A. Remiro',club:'Real Sociedad',pos:'GK',goals:0,assists:0,cleanSheets:4,saves:25,penaltySaves:0,goalsConceded:9,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:0,shotsOnTarget:0,bigChancesCreated:0,motm:0},
  // More defenders
  {id:36,name:'I. Perisic',club:'Atletico',pos:'DEF',goals:2,assists:4,cleanSheets:4,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:4,interceptions:3,keyPasses:5,shotsOnTarget:3,bigChancesCreated:1,motm:0},
  {id:37,name:'J. Navas',club:'Sevilla',pos:'DEF',goals:0,assists:2,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:5,interceptions:4,keyPasses:3,shotsOnTarget:1,bigChancesCreated:0,motm:0},
  {id:38,name:'Pau Torres',club:'Villarreal',pos:'DEF',goals:1,assists:1,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:6,interceptions:5,keyPasses:2,shotsOnTarget:2,bigChancesCreated:0,motm:1},
  {id:39,name:'A. Moreno',club:'Villarreal',pos:'DEF',goals:1,assists:3,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:4,interceptions:2,keyPasses:4,shotsOnTarget:2,bigChancesCreated:1,motm:0},
  // Extra mids
  {id:40,name:'D. Ceballos',club:'Real Madrid',pos:'MID',goals:1,assists:3,cleanSheets:2,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:4,interceptions:3,keyPasses:5,shotsOnTarget:2,bigChancesCreated:1,motm:0},
  {id:41,name:'A. Sergi Roberto',club:'Barcelona',pos:'MID',goals:1,assists:2,cleanSheets:3,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:3,interceptions:2,keyPasses:4,shotsOnTarget:1,bigChancesCreated:0,motm:0},
  {id:42,name:'C. Lemar',club:'Atletico',pos:'MID',goals:2,assists:4,cleanSheets:4,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:1,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:2,interceptions:2,keyPasses:7,shotsOnTarget:3,bigChancesCreated:2,motm:0},
  // Extra forwards
  {id:43,name:'L. Suarez',club:'Atletico',pos:'FWD',goals:4,assists:3,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:2,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:2,shotsOnTarget:8,bigChancesCreated:1,motm:0},
  {id:44,name:'F. Torres',club:'Barcelona',pos:'FWD',goals:4,assists:2,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:1,shotsOnTarget:7,bigChancesCreated:1,motm:0},
  {id:45,name:'E. Hazard',club:'Real Madrid',pos:'FWD',goals:2,assists:2,cleanSheets:0,saves:0,penaltySaves:0,goalsConceded:0,yellowCards:0,redCards:0,ownGoals:0,penaltiesMissed:0,tacklesWon:0,interceptions:0,keyPasses:2,shotsOnTarget:4,bigChancesCreated:1,motm:0},
];

// =============================================================================
// SCORING
// =============================================================================
function calcPlayerPoints(p) {
  let pts = 0;
  switch(p.pos) {
    case 'GK':
      pts += p.cleanSheets * 4;
      pts += Math.floor(p.saves / 3);
      pts += p.penaltySaves * 5;
      pts += -Math.floor(p.goalsConceded / 2);
      break;
    case 'DEF':
      pts += p.goals * 6;
      pts += p.assists * 3;
      pts += p.cleanSheets * 4;
      pts += p.tacklesWon * 1;
      pts += p.interceptions * 1;
      break;
    case 'MID':
      pts += p.goals * 5;
      pts += p.assists * 3;
      pts += p.cleanSheets * 1;
      pts += p.keyPasses * 1;
      pts += p.shotsOnTarget * 1;
      pts += p.bigChancesCreated * 1;
      break;
    case 'FWD':
      pts += p.goals * 4;
      pts += p.assists * 3;
      pts += p.shotsOnTarget * 1;
      pts += p.bigChancesCreated * 1;
      break;
  }
  pts += p.yellowCards * -1;
  pts += p.redCards * -3;
  pts += p.ownGoals * -2;
  pts += p.penaltiesMissed * -2;
  pts += p.motm * 3;
  return pts;
}

function getPlayerPoints(id) {
  const p = STATE.playerStats.find(x => x.id === id);
  return p ? calcPlayerPoints(p) : 0;
}

function getPlayer(id) {
  return STATE.playerStats.find(x => x.id === id);
}

// =============================================================================
// INIT
// =============================================================================
function initLeague() {
  const names = [
    {name: document.getElementById('m1name').value.trim(), team: document.getElementById('m1team').value.trim()},
    {name: document.getElementById('m2name').value.trim(), team: document.getElementById('m2team').value.trim()},
    {name: document.getElementById('m3name').value.trim(), team: document.getElementById('m3team').value.trim()},
  ];

  if (names.some(m => !m.name || !m.team)) {
    showNotif('Please fill in all manager names and team names', true);
    return;
  }

  STATE.managers = names.map((m, i) => ({id: i+1, name: m.name, teamName: m.team}));
  STATE.playerStats = JSON.parse(JSON.stringify(SEED_PLAYERS));

  // Calculate GK saves bonus (every 3 saves)
  STATE.playerStats.forEach(p => {
    if (p.pos === 'GK') p.savesBonus = Math.floor(p.saves / 3);
  });

  // Init squad storage
  STATE.managers.forEach(m => {
    STATE.squads[m.id] = {gk: [], def: [], mid: [], fwd: []};
    STATE.lineups[m.id] = {};
    STATE.gwHistory[m.id] = {};
    STATE.transfersThisGW[m.id] = 0;
  });

  // Build snake draft order (3 managers, 15 picks each = 45 picks)
  buildDraftOrder();

  // Populate team filter
  const clubs = [...new Set(STATE.playerStats.map(p => p.club))].sort();
  const tf = document.getElementById('teamFilter');
  clubs.forEach(c => {
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    tf.appendChild(o);
  });

  // Populate manager selects
  ['myteamManager', 'transferManager'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    STATE.managers.forEach(m => {
      const o = document.createElement('option');
      o.value = m.id; o.textContent = `${m.name} ‚Äî ${m.teamName}`;
      sel.appendChild(o);
    });
  });

  document.getElementById('setupModal').classList.remove('open');
  saveState();
  updateAll();
  showNotif('League initialised! Head to the Draft to get started.');
}

function buildDraftOrder() {
  const n = STATE.managers.length;
  const picksEach = 15;
  STATE.draftOrder = [];
  for (let round = 0; round < picksEach; round++) {
    const order = round % 2 === 0
      ? STATE.managers.map(m => m.id)
      : [...STATE.managers.map(m => m.id)].reverse();
    order.forEach((mid, idx) => {
      STATE.draftOrder.push({
        pick: round * n + idx + 1,
        managerId: mid,
        playerId: null,
        playerName: null,
      });
    });
  }
}

// =============================================================================
// NAVIGATION
// =============================================================================
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => {
    if (b.textContent.toLowerCase().includes(page.substring(0,4))) b.classList.add('active');
  });

  if (page === 'draft') renderDraft();
  if (page === 'myteam') renderMyTeam();
  if (page === 'transfers') renderTransfers();
  if (page === 'players') renderPlayers();
  if (page === 'leaderboard') renderLeaderboard();
  if (page === 'log') renderLog();
  if (page === 'dashboard') renderDashboard();
}

// =============================================================================
// RENDER DASHBOARD
// =============================================================================
function renderDashboard() {
  if (!STATE.managers.length) return;

  document.getElementById('dashGW').textContent = `GW ${STATE.currentGW}`;
  document.getElementById('gwBadge').textContent = `GW ${STATE.currentGW}`;

  // Stat boxes
  const totalTransfers = STATE.transfers.length;
  const topManager = STATE.managers.reduce((best, m) => {
    const pts = getTotalPoints(m.id);
    return pts > getTotalPoints(best.id) ? m : best;
  }, STATE.managers[0]);

  document.getElementById('dashStats').innerHTML = `
    <div class="stat-box">
      <div class="stat-value">${STATE.currentGW}</div>
      <div class="stat-label">Current Gameweek</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" style="color:var(--pink);text-shadow:var(--glow-pink);">${STATE.managers.length}</div>
      <div class="stat-label">Managers</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" style="color:var(--gold);">${totalTransfers}</div>
      <div class="stat-label">Total Transfers</div>
    </div>
  `;

  // Dashboard leaderboard
  const sortedMgrs = [...STATE.managers].sort((a, b) => getTotalPoints(b.id) - getTotalPoints(a.id));
  document.getElementById('dashLeaderboard').innerHTML = sortedMgrs.map((m, i) => `
    <div class="lb-row">
      <div class="lb-rank ${i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':''}">${i===0?'üëë':i+1}</div>
      <div>
        <div class="lb-manager">${m.name}</div>
        <div class="lb-team">${m.teamName}</div>
      </div>
      <div class="lb-pts">${getTotalPoints(m.id)}</div>
      <div class="text-sm">Total</div>
    </div>
  `).join('');

  // This week
  const gwPts = STATE.managers.map(m => ({
    m, pts: getGWPoints(m.id, STATE.currentGW)
  })).sort((a, b) => b.pts - a.pts);
  document.getElementById('dashThisWeek').innerHTML = gwPts.map((item, i) => `
    <div class="flex gap-1 mb-1" style="align-items:center; border-bottom:1px solid var(--border); padding-bottom:0.75rem;">
      <div style="font-size:1.2rem;">${i===0?'ü•á':i===1?'ü•à':'ü•â'}</div>
      <div style="flex:1;">
        <div class="fw-bold">${item.m.name}</div>
        <div class="text-sm">${item.m.teamName}</div>
      </div>
      <div class="lb-pts">${item.pts} pts</div>
    </div>
  `).join('') || '<div class="empty-state">No gameweek data yet</div>';
}

// =============================================================================
// DRAFT RENDER
// =============================================================================
function renderDraft() {
  const container = document.getElementById('draftContent');
  if (!STATE.managers.length) {
    container.innerHTML = '<div class="empty-state">League not yet initialised</div>';
    return;
  }

  if (STATE.draftComplete) {
    container.innerHTML = `
      <div class="card mb-1">
        <div class="card-header"><span class="card-title">DRAFT COMPLETE ‚úÖ</span></div>
        <div class="card-body">
          <p class="text-sm mb-1">The draft is locked. All squads have been assigned.</p>
          <div class="grid-3">
            ${STATE.managers.map(m => `
              <div class="stat-box">
                <div class="stat-value" style="font-size:1.5rem;">${getSquadSize(m.id)}</div>
                <div class="stat-label">${m.name}</div>
                <div class="text-sm mt-1">${m.teamName}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
    return;
  }

  const currentPick = STATE.draftOrder[STATE.draftPickIdx];
  const currentManager = currentPick ? STATE.managers.find(m => m.id === currentPick.managerId) : null;

  // Available players
  const ownedIds = getOwnedPlayerIds();
  const availablePlayers = STATE.playerStats.filter(p => !ownedIds.includes(p.id));

  container.innerHTML = `
    <div class="grid-2 mb-15">
      <div class="card">
        <div class="card-header">
          <span class="card-title">DRAFT ORDER</span>
          <span class="text-sm">Pick ${STATE.draftPickIdx + 1} / ${STATE.draftOrder.length}</span>
        </div>
        <div style="max-height:350px; overflow-y:auto;">
          ${STATE.draftOrder.slice(0, 15).map((pick, i) => {
            const mgr = STATE.managers.find(m => m.id === pick.managerId);
            const isCurrent = i === STATE.draftPickIdx;
            return `<div class="draft-pick-row ${isCurrent ? 'pick-current' : pick.playerId ? 'player-owned' : ''}">
              <span class="pick-num">Pick ${pick.pick}</span>
              <span class="pick-manager" style="color:${isCurrent?'var(--pink)':'inherit'}">${mgr?.name}</span>
              ${pick.playerName ? `<span class="text-sm color-teal">${pick.playerName}</span>` : isCurrent ? '<span class="color-pink text-sm">‚üµ ON CLOCK</span>' : ''}
            </div>`;
          }).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">SQUAD STATUS</span>
        </div>
        <div class="card-body">
          ${STATE.managers.map(m => {
            const s = STATE.squads[m.id];
            const gk = s.gk.length, def = s.def.length, mid = s.mid.length, fwd = s.fwd.length;
            return `<div class="flex gap-1 mb-1" style="align-items:center;">
              <div style="flex:1;"><div class="fw-bold">${m.name}</div><div class="text-sm">${m.teamName}</div></div>
              <div class="text-sm text-mono">GK:${gk} DEF:${def} MID:${mid} FWD:${fwd}</div>
            </div>`;
          }).join('')}
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">
          ${currentManager ? `üïê ${currentManager.name.toUpperCase()}'S PICK` : 'DRAFT COMPLETE'}
        </span>
        <div class="flex gap-05">
          <select class="filter-select" id="draftPos" onchange="renderDraftPlayers()" style="font-size:0.75rem;">
            <option value="">All</option>
            <option value="GK">GK</option>
            <option value="DEF">DEF</option>
            <option value="MID">MID</option>
            <option value="FWD">FWD</option>
          </select>
          <input class="filter-input" type="text" placeholder="Search..." id="draftSearch" oninput="renderDraftPlayers()" style="width:120px;">
        </div>
      </div>
      <div class="table-wrap">
        <table class="player-table">
          <thead><tr>
            <th>Player</th><th>Pos</th><th>Club</th><th>Pts</th><th></th>
          </tr></thead>
          <tbody id="draftPlayerList"></tbody>
        </table>
      </div>
    </div>
  `;
  renderDraftPlayers();
}

function renderDraftPlayers() {
  const pos = document.getElementById('draftPos')?.value || '';
  const search = document.getElementById('draftSearch')?.value.toLowerCase() || '';
  const ownedIds = getOwnedPlayerIds();

  let players = STATE.playerStats.filter(p => !ownedIds.includes(p.id));
  if (pos) players = players.filter(p => p.pos === pos);
  if (search) players = players.filter(p => p.name.toLowerCase().includes(search) || p.club.toLowerCase().includes(search));
  players.sort((a, b) => calcPlayerPoints(b) - calcPlayerPoints(a));

  const currentPick = STATE.draftOrder[STATE.draftPickIdx];

  document.getElementById('draftPlayerList').innerHTML = players.map(p => `
    <tr>
      <td class="fw-bold">${p.name}</td>
      <td><span class="pos-badge pos-${p.pos}">${p.pos}</span></td>
      <td class="text-sm">${p.club}</td>
      <td class="color-teal text-mono">${calcPlayerPoints(p)}</td>
      <td>${currentPick ? `<button class="btn btn-teal btn-sm" onclick="draftPick(${p.id})">PICK</button>` : ''}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="empty-state">No players available</td></tr>';
}

function draftPick(playerId) {
  if (STATE.draftComplete) { showNotif('Draft is complete!', true); return; }
  const pick = STATE.draftOrder[STATE.draftPickIdx];
  if (!pick) return;

  const player = STATE.playerStats.find(p => p.id === playerId);
  const manager = STATE.managers.find(m => m.id === pick.managerId);
  const squad = STATE.squads[pick.managerId];

  // Check squad limits: 2 GK, 5 DEF, 5 MID, 3 FWD
  const limits = {GK: 2, DEF: 5, MID: 5, FWD: 3};
  const posKey = player.pos.toLowerCase();
  if (squad[posKey].length >= limits[player.pos]) {
    showNotif(`${manager.name} already has ${limits[player.pos]} ${player.pos}s!`, true);
    return;
  }

  pick.playerId = playerId;
  pick.playerName = player.name;
  squad[posKey].push(playerId);
  STATE.draftPickIdx++;

  if (STATE.draftPickIdx >= STATE.draftOrder.length) {
    STATE.draftComplete = true;
    // Auto-set default lineups
    STATE.managers.forEach(m => setDefaultLineup(m.id));
    showNotif('üèÜ Draft complete! All squads locked.');
  } else {
    const next = STATE.managers.find(m => m.id === STATE.draftOrder[STATE.draftPickIdx].managerId);
    showNotif(`${manager.name} picked ${player.name}. ${next?.name}'s turn!`);
  }

  saveState();
  renderDraft();
}

function setDefaultLineup(managerId) {
  const s = STATE.squads[managerId];
  const gw = STATE.currentGW;
  const lineup = {
    gk: s.gk.slice(0, 1),
    def: s.def.slice(0, 4),
    mid: s.mid.slice(0, 4),
    fwd: s.fwd.slice(0, 2),
    flex: [],
    captain: s.mid[0] || s.fwd[0] || s.gk[0],
    bench: [...s.gk.slice(1), ...s.def.slice(4), ...s.mid.slice(4), ...s.fwd.slice(2)],
  };
  // Pick flex (11th outfield)
  const allOutfield = [...s.def, ...s.mid, ...s.fwd];
  const usedIds = [...lineup.gk, ...lineup.def, ...lineup.mid, ...lineup.fwd];
  const flexCandidate = allOutfield.find(id => !usedIds.includes(id));
  if (flexCandidate) {
    lineup.flex = [flexCandidate];
    lineup.bench = lineup.bench.filter(id => id !== flexCandidate);
  }
  STATE.lineups[managerId][gw] = lineup;
}

// =============================================================================
// MY TEAM
// =============================================================================
function renderMyTeam() {
  const managerId = parseInt(document.getElementById('myteamManager').value);
  const manager = STATE.managers.find(m => m.id === managerId);
  const gw = STATE.currentGW;
  const lineup = STATE.lineups[managerId]?.[gw];

  document.getElementById('myteamPts').textContent = `GW ${gw} Points: ${getGWPoints(managerId, gw)}`;

  if (!lineup) {
    document.getElementById('myteamContent').innerHTML = '<div class="empty-state">No lineup set yet. Complete the draft first.</div>';
    return;
  }

  const renderPlayerCard = (id, isBench = false, showCapBtn = true) => {
    const p = getPlayer(id);
    if (!p) return '';
    const pts = calcPlayerPoints(p);
    const isCap = lineup.captain === id;
    const finalPts = isCap ? pts * 2 : pts;
    return `
      <div class="player-card ${isBench ? 'bench' : ''} ${isCap ? 'captain' : ''}" onclick="showPlayerDetail(${id})">
        ${isCap ? '<div class="captain-crown">¬©√ó2</div>' : ''}
        <span class="pos-badge pos-${p.pos}" style="font-size:0.5rem;">${p.pos}</span>
        <div class="player-card-name mt-1">${p.name.split(' ').pop()}</div>
        <div class="player-card-pts">${finalPts}</div>
        <div class="text-sm" style="font-size:0.65rem;">${p.club}</div>
        ${!isBench && showCapBtn ? `<button class="btn btn-gold btn-sm" style="font-size:0.55rem;padding:2px 6px;margin-top:4px;" onclick="event.stopPropagation();setCaptain(${managerId},${id})">¬© CAP</button>` : ''}
      </div>
    `;
  };

  document.getElementById('myteamContent').innerHTML = `
    <div class="pitch mb-1">
      <div class="squad-grid">
        <div class="section-label">GOALKEEPER</div>
        <div class="squad-row">${lineup.gk.map(id => renderPlayerCard(id)).join('')}</div>
        <div class="section-label">DEFENDERS</div>
        <div class="squad-row">${lineup.def.map(id => renderPlayerCard(id)).join('')}</div>
        <div class="section-label">MIDFIELDERS</div>
        <div class="squad-row">${lineup.mid.map(id => renderPlayerCard(id)).join('')}</div>
        <div class="section-label">FORWARDS</div>
        <div class="squad-row">${lineup.fwd.map(id => renderPlayerCard(id)).join('')}</div>
        ${lineup.flex.length ? `
          <div class="section-label">FLEX</div>
          <div class="squad-row">${lineup.flex.map(id => renderPlayerCard(id)).join('')}</div>
        ` : ''}
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">BENCH</span>
        <span class="text-sm">Click a starter to swap with bench</span>
      </div>
      <div class="card-body">
        <div class="squad-row">${lineup.bench.map(id => renderPlayerCard(id, true, false)).join('')}</div>
      </div>
    </div>
    <div class="card mt-1">
      <div class="card-header"><span class="card-title">SQUAD OVERVIEW</span></div>
      <div class="table-wrap">
        <table class="player-table">
          <thead><tr><th>Player</th><th>Pos</th><th>Club</th><th>Pts</th><th>Status</th></tr></thead>
          <tbody>
            ${getAllSquadIds(managerId).map(id => {
              const p = getPlayer(id);
              if (!p) return '';
              const isStarter = [...lineup.gk, ...lineup.def, ...lineup.mid, ...lineup.fwd, ...lineup.flex].includes(id);
              const isCap = lineup.captain === id;
              return `<tr>
                <td class="fw-bold">${p.name}${isCap?' üëë':''}</td>
                <td><span class="pos-badge pos-${p.pos}">${p.pos}</span></td>
                <td class="text-sm">${p.club}</td>
                <td class="color-teal text-mono">${isCap ? calcPlayerPoints(p)*2 : calcPlayerPoints(p)}</td>
                <td><span style="color:${isStarter?'var(--teal)':'rgba(224,247,244,0.4)'}">${isStarter?'‚úì STARTING':'BENCH'}</span></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function setCaptain(managerId, playerId) {
  const gw = STATE.currentGW;
  if (!STATE.lineups[managerId]?.[gw]) return;
  STATE.lineups[managerId][gw].captain = playerId;
  saveState();
  renderMyTeam();
  const p = getPlayer(playerId);
  showNotif(`üëë ${p.name} is now captain! Points doubled.`);
}

function showPlayerDetail(id) {
  const p = getPlayer(id);
  if (!p) return;
  const pts = calcPlayerPoints(p);
  document.getElementById('pModalName').textContent = `${p.name} ‚Äî ${p.club}`;
  document.getElementById('pModalContent').innerHTML = `
    <div class="flex gap-1 mb-1" style="flex-wrap:wrap;">
      <span class="pos-badge pos-${p.pos}">${p.pos}</span>
      <span class="text-sm">${p.club}</span>
    </div>
    <div class="grid-3 mb-1">
      <div class="stat-box" style="padding:0.75rem;"><div class="stat-value">${pts}</div><div class="stat-label">Total Pts</div></div>
      <div class="stat-box" style="padding:0.75rem;"><div class="stat-value" style="font-size:1.5rem;color:var(--pink);">${p.goals}</div><div class="stat-label">Goals</div></div>
      <div class="stat-box" style="padding:0.75rem;"><div class="stat-value" style="font-size:1.5rem;">${p.assists}</div><div class="stat-label">Assists</div></div>
    </div>
    <div class="grid-2">
      <div style="font-size:0.85rem;">
        ${p.pos==='GK'?`<div class="flex gap-1"><span class="text-sm">Clean Sheets:</span><span>${p.cleanSheets}</span></div>
          <div class="flex gap-1"><span class="text-sm">Saves:</span><span>${p.saves}</span></div>
          <div class="flex gap-1"><span class="text-sm">Penalty Saves:</span><span>${p.penaltySaves}</span></div>`:''}
        ${p.pos==='DEF'?`<div class="flex gap-1"><span class="text-sm">Clean Sheets:</span><span>${p.cleanSheets}</span></div>
          <div class="flex gap-1"><span class="text-sm">Tackles Won:</span><span>${p.tacklesWon}</span></div>
          <div class="flex gap-1"><span class="text-sm">Interceptions:</span><span>${p.interceptions}</span></div>`:''}
        ${p.pos==='MID'?`<div class="flex gap-1"><span class="text-sm">Key Passes:</span><span>${p.keyPasses}</span></div>
          <div class="flex gap-1"><span class="text-sm">Big Chances:</span><span>${p.bigChancesCreated}</span></div>`:''}
        ${p.pos==='FWD'?`<div class="flex gap-1"><span class="text-sm">Shots on Target:</span><span>${p.shotsOnTarget}</span></div>
          <div class="flex gap-1"><span class="text-sm">Big Chances:</span><span>${p.bigChancesCreated}</span></div>`:''}
        <div class="flex gap-1"><span class="text-sm">Yellow Cards:</span><span style="color:gold">${p.yellowCards}</span></div>
        <div class="flex gap-1"><span class="text-sm">Red Cards:</span><span style="color:red">${p.redCards}</span></div>
        <div class="flex gap-1"><span class="text-sm">MOTM:</span><span>‚≠ê√ó${p.motm}</span></div>
      </div>
    </div>
  `;
  document.getElementById('playerModal').classList.add('open');
}

function closePlayerModal() {
  document.getElementById('playerModal').classList.remove('open');
}

// =============================================================================
// TRANSFERS
// =============================================================================
function renderTransfers() {
  const managerId = parseInt(document.getElementById('transferManager').value);
  const txCount = STATE.transfersThisGW[managerId] || 0;
  const nextCost = (txCount + 1) * 2;

  document.getElementById('transferCostInfo').textContent = 
    `Transfers this GW: ${txCount} | Next transfer cost: -${nextCost}pts`;

  const ownedIds = getAllSquadIds(managerId);
  const freeIds = STATE.playerStats.filter(p => !getOwnedPlayerIds().includes(p.id) || ownedIds.includes(p.id)).map(p => p.id);
  // Actually: players NOT owned by anyone, or owned by this manager
  const allOwnedExceptMe = getOwnedPlayerIds().filter(id => !ownedIds.includes(id));
  const available = STATE.playerStats.filter(p => !allOwnedExceptMe.includes(p.id) && !ownedIds.includes(p.id));

  document.getElementById('transferContent').innerHTML = `
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">MY SQUAD ‚Äî SELECT OUT</span>
        </div>
        <div class="table-wrap">
          <table class="player-table">
            <thead><tr><th>Player</th><th>Pos</th><th>Pts</th><th></th></tr></thead>
            <tbody>
              ${ownedIds.map(id => {
                const p = getPlayer(id);
                if (!p) return '';
                return `<tr>
                  <td class="fw-bold">${p.name}</td>
                  <td><span class="pos-badge pos-${p.pos}">${p.pos}</span></td>
                  <td class="color-teal text-mono">${calcPlayerPoints(p)}</td>
                  <td><button class="btn btn-pink btn-sm" onclick="selectTransferOut(${managerId},${id})">OUT</button></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">AVAILABLE ‚Äî SELECT IN</span>
          <div class="flex gap-05">
            <select class="filter-select" id="txPosFilter" onchange="renderTransfers()" style="font-size:0.75rem;">
              <option value="">All</option>
              <option value="GK">GK</option><option value="DEF">DEF</option>
              <option value="MID">MID</option><option value="FWD">FWD</option>
            </select>
          </div>
        </div>
        <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
          <table class="player-table">
            <thead><tr><th>Player</th><th>Pos</th><th>Club</th><th>Pts</th><th></th></tr></thead>
            <tbody>
              ${available.sort((a,b)=>calcPlayerPoints(b)-calcPlayerPoints(a)).map(p => {
                const posF = document.getElementById('txPosFilter')?.value || '';
                if (posF && p.pos !== posF) return '';
                return `<tr>
                  <td class="fw-bold">${p.name}</td>
                  <td><span class="pos-badge pos-${p.pos}">${p.pos}</span></td>
                  <td class="text-sm">${p.club}</td>
                  <td class="color-teal text-mono">${calcPlayerPoints(p)}</td>
                  <td><button class="btn btn-teal btn-sm" onclick="selectTransferIn(${managerId},${p.id})">IN</button></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="card mt-1" id="transferConfirmBox" style="display:none;">
      <div class="card-header"><span class="card-title">CONFIRM TRANSFER</span></div>
      <div class="card-body" id="transferConfirmContent"></div>
    </div>
  `;
}

let pendingTransferOut = null;
let pendingTransferIn = null;

function selectTransferOut(managerId, playerId) {
  pendingTransferOut = {managerId, playerId};
  pendingTransferIn = null;
  const p = getPlayer(playerId);
  showNotif(`Selected OUT: ${p.name}. Now select a player to bring IN.`);
  checkPendingTransfer();
}

function selectTransferIn(managerId, playerId) {
  if (!pendingTransferOut || pendingTransferOut.managerId !== managerId) {
    showNotif('First select a player to transfer OUT from your squad', true);
    return;
  }
  pendingTransferIn = {managerId, playerId};
  checkPendingTransfer();
}

function checkPendingTransfer() {
  const box = document.getElementById('transferConfirmBox');
  if (!box) return;
  if (!pendingTransferOut || !pendingTransferIn) {
    box.style.display = 'none';
    return;
  }
  const pOut = getPlayer(pendingTransferOut.playerId);
  const pIn = getPlayer(pendingTransferIn.playerId);
  const txCount = STATE.transfersThisGW[pendingTransferOut.managerId] || 0;
  const cost = (txCount + 1) * 2;

  if (pOut.pos !== pIn.pos) {
    box.style.display = 'block';
    document.getElementById('transferConfirmContent').innerHTML = `
      <p class="text-sm" style="color:var(--pink);">‚ö† Position mismatch: ${pOut.pos} ‚Üí ${pIn.pos}. You must transfer like-for-like positions.</p>
    `;
    return;
  }

  box.style.display = 'block';
  document.getElementById('transferConfirmContent').innerHTML = `
    <div class="flex gap-1 mb-1" style="align-items:center; flex-wrap:wrap;">
      <div class="stat-box" style="flex:1;padding:1rem;">
        <div style="color:var(--pink);">OUT</div>
        <div class="fw-bold">${pOut.name}</div>
        <div class="text-sm">${pOut.club} ‚Äî ${pOut.pos}</div>
        <div class="color-teal text-mono">${calcPlayerPoints(pOut)} pts</div>
      </div>
      <div style="font-size:2rem; color:var(--teal);">‚Üí</div>
      <div class="stat-box" style="flex:1;padding:1rem;">
        <div class="color-teal">IN</div>
        <div class="fw-bold">${pIn.name}</div>
        <div class="text-sm">${pIn.club} ‚Äî ${pIn.pos}</div>
        <div class="color-teal text-mono">${calcPlayerPoints(pIn)} pts</div>
      </div>
    </div>
    <p class="text-sm mb-1">Transfer penalty: <span style="color:var(--pink);font-family:'Orbitron',monospace;">-${cost} pts</span> (Transfer #${txCount+1} this GW)</p>
    <button class="btn btn-teal" onclick="confirmTransfer()">‚úÖ CONFIRM TRANSFER (-${cost}pts)</button>
    <button class="btn btn-pink" style="margin-left:0.5rem;" onclick="cancelTransfer()">CANCEL</button>
  `;
}

function confirmTransfer() {
  if (!pendingTransferOut || !pendingTransferIn) return;
  const {managerId} = pendingTransferOut;
  const pOut = getPlayer(pendingTransferOut.playerId);
  const pIn = getPlayer(pendingTransferIn.playerId);

  // Execute swap in squad
  const s = STATE.squads[managerId];
  const posKey = pOut.pos.toLowerCase();
  const idx = s[posKey].indexOf(pendingTransferOut.playerId);
  if (idx > -1) s[posKey][idx] = pendingTransferIn.playerId;

  // Update lineup
  const gw = STATE.currentGW;
  const lineup = STATE.lineups[managerId]?.[gw];
  if (lineup) {
    ['gk','def','mid','fwd','flex','bench'].forEach(slot => {
      const arr = lineup[slot];
      if (Array.isArray(arr)) {
        const li = arr.indexOf(pendingTransferOut.playerId);
        if (li > -1) arr[li] = pendingTransferIn.playerId;
      }
    });
    if (lineup.captain === pendingTransferOut.playerId) lineup.captain = pendingTransferIn.playerId;
  }

  // Count and penalize
  STATE.transfersThisGW[managerId] = (STATE.transfersThisGW[managerId] || 0) + 1;
  const txNum = STATE.transfersThisGW[managerId];
  const penalty = txNum * 2;

  // Log
  STATE.transfers.push({
    gw: STATE.currentGW,
    managerId,
    managerName: STATE.managers.find(m => m.id === managerId)?.name,
    out: pOut.name,
    in: pIn.name,
    penalty,
    timestamp: new Date().toISOString(),
  });

  pendingTransferOut = null;
  pendingTransferIn = null;
  saveState();
  renderTransfers();
  showNotif(`‚úÖ Transfer complete! ${pOut.name} ‚Üí ${pIn.name} (-${penalty}pts)`);
}

function cancelTransfer() {
  pendingTransferOut = null;
  pendingTransferIn = null;
  document.getElementById('transferConfirmBox').style.display = 'none';
}

// =============================================================================
// PLAYERS PAGE
// =============================================================================
function renderPlayers() {
  const search = document.getElementById('playerSearch').value.toLowerCase();
  const pos = document.getElementById('posFilter').value;
  const club = document.getElementById('teamFilter').value;
  const sort = document.getElementById('sortFilter').value;
  const ownedIds = getOwnedPlayerIds();

  let players = [...STATE.playerStats];
  if (search) players = players.filter(p => p.name.toLowerCase().includes(search) || p.club.toLowerCase().includes(search));
  if (pos) players = players.filter(p => p.pos === pos);
  if (club) players = players.filter(p => p.club === club);

  if (sort === 'pts') players.sort((a,b) => calcPlayerPoints(b) - calcPlayerPoints(a));
  else if (sort === 'goals') players.sort((a,b) => b.goals - a.goals);
  else if (sort === 'assists') players.sort((a,b) => b.assists - a.assists);
  else players.sort((a,b) => a.name.localeCompare(b.name));

  const ownerName = (id) => {
    for (const m of STATE.managers) {
      if (getAllSquadIds(m.id).includes(id)) return m.name;
    }
    return '‚Äî';
  };

  document.getElementById('playerTbody').innerHTML = players.map(p => {
    const owned = ownedIds.includes(p.id);
    return `
      <tr class="${owned ? 'player-owned' : ''}" onclick="showPlayerDetail(${p.id})" style="cursor:pointer;">
        <td class="fw-bold">${p.name}</td>
        <td><span class="pos-badge pos-${p.pos}">${p.pos}</span></td>
        <td class="text-sm">${p.club}</td>
        <td>${p.goals}</td>
        <td>${p.assists}</td>
        <td>${p.cleanSheets}</td>
        <td style="color:gold">${p.yellowCards}</td>
        <td style="color:red">${p.redCards}</td>
        <td class="color-teal text-mono fw-bold">${calcPlayerPoints(p)}</td>
        <td class="text-sm">${ownerName(p.id)}</td>
        <td><button class="btn btn-teal btn-sm" onclick="event.stopPropagation();showPlayerDetail(${p.id})">INFO</button></td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="11" class="empty-state">No players found</td></tr>';
}

// =============================================================================
// LEADERBOARD
// =============================================================================
function renderLeaderboard() {
  if (!STATE.managers.length) return;

  // Populate GW select
  const lbGWSelect = document.getElementById('lbGWSelect');
  lbGWSelect.innerHTML = '';
  for (let i = 1; i <= STATE.currentGW; i++) {
    const o = document.createElement('option');
    o.value = i; o.textContent = `GW ${i}`;
    if (i === STATE.currentGW) o.selected = true;
    lbGWSelect.appendChild(o);
  }

  const selectedGW = parseInt(lbGWSelect.value) || STATE.currentGW;

  // Overall standings
  const overallSorted = [...STATE.managers].sort((a,b) => getTotalPoints(b.id) - getTotalPoints(a.id));
  document.getElementById('lbOverall').innerHTML = overallSorted.map((m, i) => {
    const totalPenalty = getTotalTransferPenalty(m.id);
    return `
      <div class="lb-row">
        <div class="lb-rank ${i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':''}">${i===0?'üëë':i+1}</div>
        <div>
          <div class="lb-manager">${m.name}</div>
          <div class="lb-team">${m.teamName}</div>
        </div>
        <div class="lb-pts">${getTotalPoints(m.id)}</div>
        <div class="text-sm">pts</div>
        <div class="text-sm" style="color:var(--pink);">${totalPenalty > 0 ? `-${totalPenalty}` : '0'} pen</div>
      </div>
    `;
  }).join('');

  // GW standings
  const gwSorted = [...STATE.managers].sort((a,b) => getGWPoints(b.id, selectedGW) - getGWPoints(a.id, selectedGW));
  document.getElementById('lbGW').innerHTML = gwSorted.map((m, i) => `
    <div class="lb-row">
      <div class="lb-rank ${i===0?'rank-1':i===1?'rank-2':''}">${i+1}</div>
      <div><div class="lb-manager">${m.name}</div></div>
      <div class="lb-pts">${getGWPoints(m.id, selectedGW)}</div>
    </div>
  `).join('');

  // Penalties
  document.getElementById('lbPenalties').innerHTML = STATE.managers.map(m => {
    const total = getTotalTransferPenalty(m.id);
    return `
      <div class="lb-row">
        <div class="lb-rank">üìã</div>
        <div><div class="lb-manager">${m.name}</div><div class="lb-team">${m.teamName}</div></div>
        <div style="color:var(--pink);font-family:'Orbitron',monospace;font-weight:700;">-${total}</div>
        <div class="text-sm">pts penalty</div>
      </div>
    `;
  }).join('');
}

// =============================================================================
// TRANSACTION LOG
// =============================================================================
function renderLog() {
  if (!STATE.transfers.length) {
    document.getElementById('txLog').innerHTML = '<div class="empty-state">No transfers yet</div>';
    return;
  }
  const sorted = [...STATE.transfers].reverse();
  document.getElementById('txLog').innerHTML = sorted.map(tx => `
    <div class="tx-item">
      <div class="tx-gw">GW ${tx.gw}</div>
      <div>
        <span class="fw-bold">${tx.managerName}</span>
        <span class="text-sm"> transferred </span>
        <span style="color:var(--pink);">${tx.out}</span>
        <span class="text-sm"> ‚Üí </span>
        <span class="color-teal">${tx.in}</span>
      </div>
      <div class="tx-penalty">-${tx.penalty}pts</div>
    </div>
  `).join('');
}

// =============================================================================
// SCORING HELPERS
// =============================================================================
function getGWPoints(managerId, gw) {
  const lineup = STATE.lineups[managerId]?.[gw];
  if (!lineup) return 0;

  let total = 0;
  const starters = [...lineup.gk, ...lineup.def, ...lineup.mid, ...lineup.fwd, ...(lineup.flex||[])];
  starters.forEach(id => {
    const pts = getPlayerPoints(id);
    total += (lineup.captain === id) ? pts * 2 : pts;
  });

  // Subtract transfer penalties for this GW
  const gwTransfers = STATE.transfers.filter(t => t.managerId === managerId && t.gw === gw);
  let gwPenalty = 0;
  gwTransfers.forEach(t => gwPenalty += t.penalty);

  return total - gwPenalty;
}

function getTotalPoints(managerId) {
  let total = 0;
  for (let gw = 1; gw <= STATE.currentGW; gw++) {
    total += getGWPoints(managerId, gw);
  }
  return total;
}

function getTotalTransferPenalty(managerId) {
  return STATE.transfers
    .filter(t => t.managerId === managerId)
    .reduce((sum, t) => sum + t.penalty, 0);
}

// =============================================================================
// UTILITY
// =============================================================================
function getOwnedPlayerIds() {
  const ids = [];
  STATE.managers.forEach(m => {
    const s = STATE.squads[m.id];
    ['gk','def','mid','fwd'].forEach(pos => ids.push(...s[pos]));
  });
  return ids;
}

function getAllSquadIds(managerId) {
  const s = STATE.squads[managerId];
  if (!s) return [];
  return [...s.gk, ...s.def, ...s.mid, ...s.fwd];
}

function getSquadSize(managerId) {
  return getAllSquadIds(managerId).length;
}

function nextGameweek() {
  showConfirm(
    'ADVANCE GAMEWEEK',
    `Advance from GW ${STATE.currentGW} to GW ${STATE.currentGW + 1}? This will reset transfer counts and lock the current lineup. Make sure all lineups are set!`,
    () => {
      STATE.currentGW++;
      document.getElementById('gwBadge').textContent = `GW ${STATE.currentGW}`;
      // Reset transfers this GW
      STATE.managers.forEach(m => {
        STATE.transfersThisGW[m.id] = 0;
        // Copy previous lineup to new GW
        const prevLineup = STATE.lineups[m.id]?.[STATE.currentGW - 1];
        if (prevLineup) {
          STATE.lineups[m.id][STATE.currentGW] = JSON.parse(JSON.stringify(prevLineup));
        } else {
          setDefaultLineup(m.id);
        }
      });
      saveState();
      updateAll();
      showNotif(`‚è≠ Advanced to Gameweek ${STATE.currentGW}!`);
    }
  );
}

function resetAll() {
  showConfirm(
    '‚ö† RESET ALL DATA',
    'This will delete ALL league data including squads, lineups, and transfers. This cannot be undone!',
    () => {
      localStorage.removeItem('fantastico_state');
      location.reload();
    }
  );
}

async function refreshStats() {
  showNotif('üîÑ Fetching latest stats from GitHub Actions cache...');
  try {
    // Try to fetch from a relative path (GitHub Actions updates this file)
    const res = await fetch('./data/laliga-stats.json');
    if (res.ok) {
      const data = await res.json();
      applyFetchedStats(data);
      showNotif('‚úÖ Stats updated from live data!');
    } else {
      throw new Error('No live data file found');
    }
  } catch(e) {
    // Use seed data with simulated randomisation for demo
    simulateStatUpdate();
    showNotif('‚ö° Stats refreshed (simulation mode ‚Äî see GitHub Actions setup for live data)');
  }
  updateAll();
}

function simulateStatUpdate() {
  // Add slight random variance to simulate a match
  STATE.playerStats.forEach(p => {
    const rand = Math.random();
    if (rand > 0.92) p.goals += 1;
    if (rand > 0.85) p.assists = Math.max(0, p.assists);
    if (rand > 0.95 && p.pos === 'GK') p.saves += Math.floor(Math.random() * 3);
  });
  STATE.lastFetch = new Date().toISOString();
  document.getElementById('updateStatus').innerHTML = `<span class="status-dot dot-live"></span><span class="text-sm text-mono" style="font-size:0.7rem;">LIVE</span>`;
  saveState();
}

function applyFetchedStats(data) {
  // data should be array of {name, club, pos, goals, assists, ...}
  if (!Array.isArray(data)) return;
  data.forEach(fetched => {
    const local = STATE.playerStats.find(p => p.name === fetched.name || p.id === fetched.id);
    if (local) Object.assign(local, fetched);
  });
  STATE.lastFetch = new Date().toISOString();
  document.getElementById('updateStatus').innerHTML = `<span class="status-dot dot-live"></span><span class="text-sm text-mono" style="font-size:0.7rem;">LIVE</span>`;
  saveState();
}

function updateAll() {
  renderDashboard();
}

// =============================================================================
// CONFIRM MODAL
// =============================================================================
function showConfirm(title, msg, onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmYes').onclick = () => { closeConfirm(); onConfirm(); };
  document.getElementById('confirmModal').classList.add('open');
}

function closeConfirm() {
  document.getElementById('confirmModal').classList.remove('open');
}

// =============================================================================
// NOTIFICATION
// =============================================================================
function showNotif(msg, isError = false) {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.className = 'notification' + (isError ? ' error' : '');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3500);
}

// =============================================================================
// PERSIST STATE
// =============================================================================
function saveState() {
  try {
    localStorage.setItem('fantastico_state', JSON.stringify(STATE));
  } catch(e) {}
}

function loadState() {
  try {
    const saved = localStorage.getItem('fantastico_state');
    if (saved) {
      const parsed = JSON.parse(saved);
      STATE = {...STATE, ...parsed};
      return true;
    }
  } catch(e) {}
  return false;
}

// =============================================================================
// BOOT
// =============================================================================
window.addEventListener('DOMContentLoaded', () => {
  const loaded = loadState();
  if (loaded && STATE.managers.length > 0) {
    // Restore UI
    document.getElementById('gwBadge').textContent = `GW ${STATE.currentGW}`;

    const clubs = [...new Set(STATE.playerStats.map(p => p.club))].sort();
    const tf = document.getElementById('teamFilter');
    clubs.forEach(c => {
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      tf.appendChild(o);
    });

    ['myteamManager', 'transferManager'].forEach(id => {
      const sel = document.getElementById(id);
      sel.innerHTML = '';
      STATE.managers.forEach(m => {
        const o = document.createElement('option');
        o.value = m.id; o.textContent = `${m.name} ‚Äî ${m.teamName}`;
        sel.appendChild(o);
      });
    });

    document.getElementById('setupModal').classList.remove('open');
    updateAll();
    showNotif('üëã Welcome back! League data loaded.');
  } else {
    document.getElementById('setupModal').classList.add('open');
  }
});
</script>
</body>
</html>
